# NgÄƒn Cháº·n Chia Sáº» TÃ i Khoáº£n Trong Há»‡ Thá»‘ng Thu PhÃ­

## 1. MÃ´ Táº£ BÃ i ToÃ¡n

Trong cÃ¡c há»‡ thá»‘ng Web/App cÃ³ thu phÃ­ theo tÃ i khoáº£n, viá»‡c chia sáº» tÃ i khoáº£n cho nhiá»u ngÆ°á»i sá»­ dá»¥ng dáº«n Ä‘áº¿n thiá»‡t háº¡i cho doanh nghiá»‡p. Há»‡ thá»‘ng cáº§n cÃ³ giáº£i phÃ¡p phÃ¡t hiá»‡n vÃ  ngÄƒn cháº·n viá»‡c láº¡m dá»¥ng chia sáº» tÃ i khoáº£n trong khi váº«n Ä‘áº£m báº£o tÃ­nh tráº£i nghiá»‡m cá»§a ngÆ°á»i dÃ¹ng.

## 2. PhÃ¢n tÃ­ch cÃ¡c hÃ¬nh thá»©c chia sáº» tÃ i khoáº£n phá»• biáº¿n

Má»™t sá»‘ cÃ¡c cÃ¡ch thá»©c phá»• biáº¿n mÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c dÃ¹ng Ä‘áº» chia sáº» tÃ i khoáº£n:

### a. Chia sáº» thÃ´ng tin Ä‘Äƒng nháº­p

- Má»™t ngÆ°á»i Ä‘Äƒng kÃ½ tÃ i khoáº£n vÃ  chia sáº» email/máº­t kháº©u vá»›i nhiá»u ngÆ°á»i.
- Nhá»¯ng ngÆ°á»i nÃ y cÃ³ thá»ƒ sá»­ dá»¥ng tÃ i khoáº£n tá»« nhiá»u thiáº¿t bá»‹, cÅ©ng nhÆ° Ä‘á»‹a Ä‘iá»ƒm khÃ¡c nhau.

### b. ÄÄƒng nháº­p tá»« nhiá»u thiáº¿t bá»‹ khÃ¡c nhau

- NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ Ä‘Äƒng nháº­p trÃªn nhiá»u thiáº¿t bá»‹ (PC, Ä‘iá»‡n thoáº¡i, mÃ¡y tÃ­nh báº£ng).
- Há»‡ thá»‘ng khÃ´ng giá»›i háº¡n sá»‘ lÆ°á»£ng thiáº¿t bá»‹ sá»­ dá»¥ng.

### c. Sá»­ dá»¥ng VPN hoáº·c Proxy Ä‘á»ƒ che giáº¥u Ä‘á»‹a Ä‘iá»ƒm

- NgÆ°á»i dÃ¹ng á»Ÿ nhiá»u khu vá»±c khÃ¡c nhau sá»­ dá»¥ng VPN Ä‘á»ƒ giáº£ máº¡o cÃ¹ng má»™t vá»‹ trÃ­.

### d. Tá»± Ä‘á»™ng chia sáº» phiÃªn Ä‘Äƒng nháº­p

- NgÆ°á»i dÃ¹ng cÃ³ má»™t sá»‘ kiáº¿n thá»©c vá» cookie hay token cÃ³ thá»ƒ sá»­ dá»¥ng chÃºng chia sáº½ cho nhá»¯ng ngÆ°á»i khÃ¡c.

## 3. ÄÃ¡nh giÃ¡ Æ°u nhÆ°á»£c Ä‘iá»ƒm cá»§a cÃ¡c phÆ°Æ¡ng phÃ¡p phÃ¡t hiá»‡n vÃ  ngÄƒn cháº·n.

| PhÆ°Æ¡ng phÃ¡p |	Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm |
| -- | -- | -- |
| Giá»›i háº¡n sá»‘ lÆ°á»£ng thiáº¿t bá»‹ | Dá»… triá»ƒn khai, kiá»ƒm soÃ¡t trá»±c tiáº¿p | NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ gá»¡ thiáº¿t bá»‹ cÅ© vÃ  thÃªm thiáº¿t bá»‹ má»›i liÃªn tá»¥c |
| PhÃ¡t hiá»‡n Ä‘Äƒng nháº­p tá»« nhiá»u Ä‘á»‹a chá»‰ IP/Ä‘á»‹a lÃ½ khÃ¡c nhau | Hiá»‡u quáº£ khi phÃ¡t hiá»‡n tÃ i khoáº£n bá»‹ chia sáº» giá»¯a nhiá»u quá»‘c gia/khu vá»±c | NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ sá»­ dá»¥ng VPN Ä‘á»ƒ bypass |
| PhÃ¢n tÃ­ch hÃ nh vi ngÆ°á»i dÃ¹ng | Nháº­n diá»‡n chÃ­nh xÃ¡c hÆ¡n báº±ng cÃ¡ch theo dÃµi cÃ¡ch ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tÃ¡c vá»›i há»‡ thá»‘ng | YÃªu cáº§u AI/ML vÃ  cáº§n thá»i gian Ä‘á»ƒ thu tháº­p dá»¯ liá»‡u |
| Sá»­ dá»¥ng fingerprinting (Nháº­n dáº¡ng trÃ¬nh duyá»‡t/tháº¿t bá»‹) | Nháº­n diá»‡n chÃ­nh xÃ¡c thiáº¿t bá»‹, trÃ¡nh viá»‡c Ä‘á»•i thiáº¿t bá»‹ liÃªn tá»¥c | Má»™t sá»‘ trÃ¬nh duyá»‡t cÃ³ thá»ƒ cháº·n fingerprint |
| XÃ¡c thá»±c 2 bÆ°á»›c khi phÃ¡t hiá»‡n báº¥t thÆ°á»ng | Háº¡n cháº¿ tÃ i khoáº£n bá»‹ dÃ¹ng bá»Ÿi nhiá»u ngÆ°á»i | GÃ¢y báº¥t tiá»‡n cho ngÆ°á»i dÃ¹ng há»£p lá»‡ |

## 4. Äá» xuáº¥t giáº£i phÃ¡p phÃ¹ há»£p

### a. Giá»›i háº¡n sá»‘ lÆ°á»£ng thiáº¿t bá»‹ Ä‘Äƒng nháº­p

- Má»—i tÃ i khoáº£n chá»‰ Ä‘Æ°á»£c Ä‘Äƒng nháº­p trÃªn N thiáº¿t bá»‹ (cáº¥u hÃ¬nh Ä‘Æ°á»£c).
- Khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p tá»« thiáº¿t bá»‹ thá»© (N+1), yÃªu cáº§u há» xÃ³a má»™t thiáº¿t bá»‹ cÅ©.
- LÆ°u trá»¯ thÃ´ng tin thiáº¿t bá»‹ trong CSDL Ä‘á»ƒ quáº£n lÃ½.

### b. XÃ¡c Ä‘á»‹nh vá»‹ trÃ­ Ä‘á»‹a lÃ½ vÃ  Ä‘á»‹a chá»‰ IP báº¥t thÆ°á»ng

- Náº¿u phÃ¡t hiá»‡n Ä‘Äƒng nháº­p tá»« má»™t khu vá»±c khÃ¡c trong thá»i gian ngáº¯n â†’ Cáº£nh bÃ¡o hoáº·c yÃªu cáº§u xÃ¡c minh.
- Náº¿u má»™t tÃ i khoáº£n liÃªn tá»¥c Ä‘Äƒng nháº­p tá»« nhiá»u Ä‘á»‹a chá»‰ IP khÃ¡c nhau trong thá»i gian ngáº¯n â†’ Cáº§n xÃ¡c thá»±c thÃªm (OTP, captcha).

### c. PhÃ¢n tÃ­ch hÃ nh vi ngÆ°á»i dÃ¹ng

- Ghi láº¡i cÃ¡c hÃ nh vi nhÆ°: Thá»i gian Ä‘Äƒng nháº­p, thá»i gian sá»­ dá»¥ng, ná»™i dung truy cáº­p.
- Tá»« Ä‘Ã³ cÃ³ thá»ƒ tÃ­ch há»£p cÃ¡c model AI Ä‘á»ƒ xÃ¡c Ä‘á»‹nh hÃ nh vi sá»­ dá»¥ng khÃ´ng giá»‘ng vá»›i cÃ¡c phiÃªn trÆ°á»›c Ä‘Ã³ â†’ ÄÃ¡nh dáº¥u lÃ  báº¥t thÆ°á»ng.

### d. Sá»­ dá»¥ng Fingerprinting Ä‘á»ƒ nháº­n diá»‡n thiáº¿t bá»‹

- Thu tháº­p thÃ´ng tin thiáº¿t bá»‹ (user-agent, device-infomation,...).
- Náº¿u phÃ¡t hiá»‡n fingerprint má»›i mÃ  khÃ´ng pháº£i thiáº¿t bá»‹ Ä‘Ã£ lÆ°u trá»¯ â†’ XÃ¡c minh láº¡i danh tÃ­nh ngÆ°á»i dÃ¹ng.

### e. Ãp dá»¥ng xÃ¡c thá»±c hai bÆ°á»›c (2FA) khi phÃ¡t hiá»‡n rá»§i ro

- Khi phÃ¡t hiá»‡n Ä‘Äƒng nháº­p báº¥t thÆ°á»ng (vá»‹ trÃ­ má»›i, thiáº¿t bá»‹ má»›i, fingerprint má»›i) â†’ YÃªu cáº§u xÃ¡c thá»±c qua email/SMS.

## 5. Triá»ƒn khai Demo

### a. Thiáº¿t káº¿ Class diagram

![Class](/diagrams/class.png)

### b. Thiáº¿t káº¿ sequence diagram

![Flow](/diagrams/flow.png)

#### a. NgÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p

- NgÆ°á»i dÃ¹ng nháº­p email vÃ  máº­t kháº©u trÃªn giao diá»‡n.
- á»¨ng dá»¥ng gá»­i yÃªu cáº§u Ä‘Äƒng nháº­p kÃ¨m theo ID thiáº¿t bá»‹, fingerprint, vÃ  IP.

#### b. Kiá»ƒm tra sá»‘ lÆ°á»£ng thiáº¿t bá»‹

- Backend truy váº¥n danh sÃ¡ch thiáº¿t bá»‹ Ä‘ang hoáº¡t Ä‘á»™ng cá»§a ngÆ°á»i dÃ¹ng.
- Náº¿u vÆ°á»£t quÃ¡ giá»›i háº¡n cho phÃ©p, yÃªu cáº§u Ä‘Äƒng nháº­p bá»‹ tá»« chá»‘i.

#### c. XÃ¡c minh danh tÃ­nh

- Náº¿u sá»‘ thiáº¿t bá»‹ há»£p lá»‡, há»‡ thá»‘ng tiáº¿p tá»¥c xÃ¡c minh fingerprint & geolocation.
- Náº¿u phÃ¡t hiá»‡n Ä‘Äƒng nháº­p báº¥t thÆ°á»ng, há»‡ thá»‘ng yÃªu cáº§u MFA (xÃ¡c thá»±c hai yáº¿u tá»‘).

#### d. XÃ¡c thá»±c MFA (náº¿u cáº§n)

- Náº¿u mÃ£ MFA há»£p lá»‡, phiÃªn Ä‘Äƒng nháº­p Ä‘Æ°á»£c lÆ°u vÃ o database vÃ  ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ truy cáº­p.
- Náº¿u mÃ£ MFA khÃ´ng há»£p lá»‡, yÃªu cáº§u bá»‹ tá»« chá»‘i.

#### e. LÆ°u phiÃªn vÃ  phÃ¢n tÃ­ch hÃ nh vi

- Náº¿u Ä‘Äƒng nháº­p bÃ¬nh thÆ°á»ng, há»‡ thá»‘ng lÆ°u phiÃªn vÃ o database.
- Há»‡ thá»‘ng ghi log hoáº¡t Ä‘á»™ng Ä‘á»ƒ phÃ¢n tÃ­ch hÃ nh vi cá»§a ngÆ°á»i dÃ¹ng.
- Má»™t job Ä‘Æ°á»£c lÃªn lá»‹ch Ä‘á»ƒ kiá»ƒm tra cÃ¡c phiÃªn báº¥t thÆ°á»ng theo thá»i gian.

## 6. Cháº¡y á»¨ng dá»¥ng

### a. Khá»Ÿi táº¡o env

```cmd
cp .env.example .env
```

### b. Cháº¡y á»©ng dá»¥ng

```cmd
docker-compose up -d
```

### c. Cháº¡y migration

```cmd
docker exec -it prep_app php artisan migrate
```

### d. Cháº¡y seed database

```cmd
docker exec -it prep_app php artisan db:seed
```

## 7. CÃ¡ch thá»±c hiá»‡n 

### a. API ÄÄƒng nháº­p

#### **ğŸ“Œ Gá»­i yÃªu cáº§u Ä‘Äƒng nháº­p**
**Method**: `POST`  
**URL**: `http://localhost:8000/api/login`  
**Headers**:  
```json
{
  "Content-Type": "application/json",
  "X-Device-ID": "deviceA",
  "X-Device-info": {"name": "deviceA", "user-agent": "chrome"}
}
```
**Body (JSON - raw)**:  
```json
{
  "email": "test@example.com",
  "password": "12345678"
}
```
**Káº¿t quáº£ mong Ä‘á»£i**:
- âœ… **Náº¿u há»£p lá»‡** â†’ Tráº£ vá» **token** (`token`).
- âŒ **Náº¿u quÃ¡ sá»‘ thiáº¿t bá»‹** â†’ `"Too many devices"` (403).
- âš  **Náº¿u nghi ngá» chia sáº» tÃ i khoáº£n** â†’ **YÃªu cáº§u nháº­p MFA**.

---

#### **XÃ¡c thá»±c MFA (náº¿u cáº§n)**
Náº¿u nháº­n `"MFA required"`, gá»­i tiáº¿p yÃªu cáº§u:  

**Method**: `POST`
**URL**: `http://localhost:8000/api/verify-mfa`  
**Headers**:  
```json
{
  "Content-Type": "application/json",
  "X-Device-ID": "deviceA",
  "X-Device-info": {"name": "deviceA", "user-agent": "chrome"}
}
```
**Body (JSON - raw)**:  
```json
{
  "email": "test@example.com",
  "mfa_code": "123456"
}
```
**Káº¿t quáº£ mong Ä‘á»£i**:
- âœ… **Náº¿u mÃ£ Ä‘Ãºng** â†’ Cho phÃ©p Ä‘Äƒng nháº­p.
- âŒ **Náº¿u sai** â†’ `"Invalid MFA code"` (401).

## 8. Tá»•ng káº¿t

Máº·c dÃ¹ thá»i gian lÃ m bÃ i test dÃ i, tÃ´i chÆ°a táº­n dá»¥ng Ä‘Æ°á»£c thá»i gian cá»§a mÃ¬nh má»™t cÃ¡ch tá»‘i Æ°u, dáº«n Ä‘áº¿n pháº§n triá»ƒn khai chÆ°a hoÃ n thiá»‡n Ä‘áº§y Ä‘á»§. Trong tÆ°Æ¡ng lai, náº¿u cÃ³ thÃªm thá»i gian, tÃ´i sáº½ táº­p trung phÃ¡t triá»ƒn cÃ¡c pháº§n sau:

- **Tá»‘i Æ°u thiáº¿t káº¿ database**: Chia báº£ng `device` vÃ  `session` riÃªng Ä‘á»ƒ quáº£n lÃ½ tá»‘t hÆ¡n.
- **Tá»‘i Æ°u query**: Cáº£i thiá»‡n hiá»‡u suáº¥t truy váº¥n khi xá»­ lÃ½ táº­p dá»¯ liá»‡u lá»›n.
- **Cáº£i thiá»‡n logic phÃ¢n tÃ­ch hÃ nh vi**: ThÃªm logic trong pháº§n job Ä‘á»ƒ phÃ¢n tÃ­ch hÃ nh vi ngÆ°á»i dÃ¹ng chi tiáº¿t hÆ¡n.
- **Bá»• sung transaction**: Sá»­ dá»¥ng transaction á»Ÿ nhá»¯ng pháº§n quan trá»ng Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n dá»¯ liá»‡u.
- **Cáº¥u trÃºc láº¡i Ä‘á»ƒ sá»­ dá»¥ng Redis**: LÆ°u trá»¯ phiÃªn Ä‘Äƒng nháº­p, giá»›i háº¡n thiáº¿t bá»‹ vÃ  cache dá»¯ liá»‡u Ä‘á»ƒ giáº£m táº£i truy váº¥n vÃ o database.
- **TÃ­ch há»£p Kafka**: Sá»­ dá»¥ng Kafka Ä‘á»ƒ xá»­ lÃ½ cÃ¡c sá»± kiá»‡n báº¥t Ä‘á»“ng bá»™ nhÆ° phÃ¢n tÃ­ch hÃ nh vi, phÃ¡t hiá»‡n gian láº­n nháº±m tá»‘i Æ°u há»‡ thá»‘ng khi má»Ÿ rá»™ng job.

ÄÃ¢y lÃ  nhá»¯ng Ä‘iá»ƒm cáº§n cáº£i thiá»‡n Ä‘á»ƒ nÃ¢ng cao hiá»‡u suáº¥t vÃ  kháº£ nÄƒng má»Ÿ rá»™ng cá»§a há»‡ thá»‘ng.
